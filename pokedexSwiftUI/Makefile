PROJECT      := pokedexSwiftUI.xcodeproj
SCHEME       := pokedexSwiftUI
CONFIG       := Debug
DEST         := generic/platform=iOS Simulator
DDIR         := .build/DerivedData
ARCHIVE_LOG  := build.log

# Filtro de "ru√≠do" (adicione termos que voc√™ quer esconder)
NOISE_FILTER := -e appintentsmetadataprocessor -e "No AppShortcuts found"

.PHONY: build
build:
	@echo "üî® Building $(SCHEME) (silencioso e sem boot do simulador)‚Ä¶"
	@rm -rf $(DDIR)
	@mkdir -p $(DDIR)
	@set -o pipefail; \
	xcodebuild build \
		-project "$(PROJECT)" \
		-scheme "$(SCHEME)" \
		-configuration "$(CONFIG)" \
		-destination '$(DEST)' \
		-derivedDataPath "$(DDIR)" \
		-showBuildTimingSummary \
		-disableAutomaticPackageResolution \
		| tee "$(ARCHIVE_LOG)" >/dev/null
	@$(MAKE) _report
	@echo "üßπ Limpando DerivedData local‚Ä¶"
	@rm -rf "$(DDIR)"

.PHONY: _report
_report:
	@echo "‚Äî‚Äî‚Äî üìÑ RESUMO ‚Äî‚Äî‚Äî"
	@STATUS=$$(grep -Fq "** BUILD SUCCEEDED **" "$(ARCHIVE_LOG)" && echo "SUCCEEDED" || echo "FAILED"); \
	if [ "$$STATUS" = "SUCCEEDED" ]; then \
	  echo "‚úÖ BUILD SUCCEEDED"; \
	else \
	  echo "‚ùå BUILD FAILED"; \
	fi; \
	\
	WARN=$$(grep -E ":[0-9]+:[0-9]+: warning:" "$(ARCHIVE_LOG)" 2>/dev/null | grep -v $(NOISE_FILTER) | wc -l | tr -d ' '); \
	ERR=$$(grep -E ":[0-9]+:[0-9]+: error:"   "$(ARCHIVE_LOG)" 2>/dev/null | wc -l | tr -d ' '); \
	[ -z "$$WARN" ] && WARN=0; [ -z "$$ERR" ] && ERR=0; \
	echo "‚ö†Ô∏è  Warnings: $$WARN"; \
	echo "‚õî  Erros:    $$ERR"; \
	echo; \
	if [ "$$ERR" -gt 0 ]; then \
	  echo "‚Äî Erros ‚Äî"; \
	  grep -E ":[0-9]+:[0-9]+: error:" "$(ARCHIVE_LOG)" \
	    | sed -E 's#^/Users/.*/pokedexSwiftUI/##' \
	    | awk '!seen[$$0]++' | head -n 50; \
	  echo; \
	fi; \
	if [ "$$WARN" -gt 0 ]; then \
	  echo "‚Äî Warnings (filtrados) ‚Äî"; \
	  grep -E ":[0-9]+:[0-9]+: warning:" "$(ARCHIVE_LOG)" \
	    | grep -v $(NOISE_FILTER) \
	    | sed -E 's#^/Users/.*/pokedexSwiftUI/##' \
	    | awk '!seen[$$0]++' | head -n 50; \
	  echo; \
	fi; \
	echo "‚Äî Build Timing Summary ‚Äî"; \
	awk '/^Build Timing Summary/{flag=1;next}/^[[:space:]]*$$/{flag=0}flag' "$(ARCHIVE_LOG)" | sed 's/^/  /'